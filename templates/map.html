{% extends "base_template.html" %}

{% block title %}Mapping{% endblock %}

{% block page_stylesheets %}
<link rel="stylesheet" href="/Media/jquery-ui/css/jquery-ui.css" type="text/css" media="screen" charset="utf-8">
<link rel="stylesheet" href="/Media/css/ui.slider.extras.css" type="text/css" media="screen" charset="utf-8">
<link rel="stylesheet" href="/Media/css/map.css" type="text/css" media="screen" charset="utf-8">


{% endblock %}
{% block javascripts %}
<script type="text/javascript" src="/Media/jquery-ui/js/jquery-ui.min.js"></script>
<script type="text/javascript" src="/Media/js/map.js"></script>
 <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key={{map_key}}" type="text/javascript"></script>
<script type="text/javascript" src="/Media/js/selectToUISlider.jQuery.js"></script>
<script type="text/javascript">
// FIXME - be consistent: either all JS goes here (and not in map.js), or
// all goes in map.js.
// The only exception should be variables that are initialized from values passed
// to the template, a single init() call could be made here, for example:
// init({{ minLat }}, {{ maxLat }}, {{ minLon }}, {{ maxLon }}, {{ Map_urls }}, {{ map_types }});
var layerContainer = $('#ol');
var map_urls={{Map_urls}};
var map_types={{map_types}};
var minLat={{minLat}};
var maxLat={{maxLat}};
var minLon={{minLon}};
var maxLon={{maxLon}};
var zoom=8;
var desc={};
var layerContainer;


/*function to get color given a map_url
 * each slug maps to an icon and color in a map_types
 */

 function getColor(url){

	 var z=url.split("/")
	 var slug=z[z.length-1]
	 try{  	 
	 			var color=map_types[slug][1]
	 }
	 catch(err){

	 }
	                 	
	           	 
	 return color
	 
}

 function getType(url){

	 var z=url.split("/")
	 var slug=z[z.length-1]
	                 	
	           	 
	 return slug
	 
}


 
//FIXME: more documentation, clean-up whitespace 
 /*
  *function to fetch content  and map it given a url 
  *
  *
  */
function fetchContent(url)
 {
  $.ajax({
		  type:"GET",
		  url:url,
		  dataType:"json",
		  success: function (data) {
		    $.each(data, function(key,value){
			   
			
	       // FIXME: lat and lon are the only valid values, remove
	       // legacy code		     
		    	if( (value['longitude'] != "undefined") && (value['lat'] != "undefined")&& (value['icon'] != undefined) && (value['lon'] != "None") && (value['lat'] != "None")) {
		    	// FIXME: health_facilities should not be hard-coded here, this makes maps
		    	// no longer generic!  This should be based on whether this particular
		    	// object has an icon, or not
					if (url.match('health_facilities'))
					{
					if(value['icon'].match('chart.apis.google.com'))
					{
						addMarkerSimple(value['lon'],value['lat'],value['icon']);
						
					}
					
							
							addmarker(value['lon'],value['lat'],value['title'],value['icon'],url,value['color']);
							
					
							}
						else{
							addGraph(value['heat'],parseFloat(value['lon']),parseFloat(value['lat']),value['color'],url,value['desc']);
							
							

							}
		    	}
		    	
		     
		    });
		    
		    //document.getElementById('loading').setAttribute("class", "hidden");
		    
		  }
	  
		});

  
  


	}
  

 
 /*function to add layers to the map. it checks all the layers for any wih a checkbox clicked and 
  * 
  *does a corresponding get request  for the associated data from the server 
  * 
  */ 
                          
 function addToMap(){
 	
 	map.clearOverlays();
 	
 	var url;
 	var key;
 	colors=[];
 	layerContainer.find('input:checked').each(function (){
 		key=$(this).attr('name');
 		url=map_urls[key][1] + "?start="+start_value+"&end="+end_value+"&maxLat="+ maxLat + "&maxLon=" +maxLon +"&minLat="+ minLat + "&minLon=" + minLon+"&zoom="+zoom;
 		if (key && map_urls[key][1] ){
 			colors.push(getColor(map_urls[key][1]))
 		 maxLat= map.getBounds().getNorthEast().lat();
 		maxLon=map.getBounds().getNorthEast().lng();
 		minLat=map.getBounds().getSouthWest().lat();
 		minLon=map.getBounds().getSouthWest().lng();
 		zoom=map.getZoom();
 		if (zoom>10)
 		{	
 		// FIXME hard-coded health_facilities call: again, we need this to be generic
 		// find a way to specify layers that are "manadatory" in the settings, rather
 		// than hard-coding it here
			fetchContent('/health_facilities?start=undefined&end=undefined&maxLat=3.88875&maxLon=33.80176&type=1&minLat=2.1444&minLon=31.198&zoom='+zoom);
			fetchContent(hf);
	 		}
 		addOverlays(hf);
 		
 		
 		
 			if (markers[url]==undefined || layers[url]==undefined)
 			{
 	 			fetchContent(url);
 	 			
 	 			
 	 			
 			
 			}
 			else{
 				addOverlays(url);
 				
 				
 				

 			}

 		}

 	}

 			);
 }



$(document).ready( function() {
	init();

layerContainer = $('#ol');




$.each( map_urls, function( key, val ) {
	
	var color=getColor(val[1]);
	// FIXME this generates mis-matched html (closing span tag without opening span tag), why is this here?
	// document or remove 
    layerContainer.append('<li class="fg-button ui-state-default" style="border-bottom:1px solid #ffffff;"><input type="checkbox" name="'+ key+'"></input><a href="#" ><button class="fg-button ui-state-default">'+val[0]+'</button></a><span style="width:15px;height:15px;background-color:'+color+';float:right;margin-top:3px;margin-right:6px;"></span></li>')});

var hc=$('input[name=0]');
hc.attr('checked', true);
hc.addClass('hidden');


layerContainer.find('input').click(addToMap);


addToMap();


});
</script>


{% endblock %}

{% block content %}
<!-- FIXME clean up indentation, whitespace -->
<div style="margin-bottom:29px;">

<h1>Mapping</h1>

<p class="help">
  Displays Map of Locations in the system.
</p>
<p class="help" style="float:right;margin-right:150px;margin-top:-25px;">
  layers
</p>
<div id="map"style="float:left;width:700px;height:400px;border:1px solid #1ebfd2;">


</div>
<div id="loading" class="hidden" style="z-index:7890;width:220px;height:17px;position:absolute;top:250px;left:250px;">
<img src="/Media/img/loading.gif" border="0"></img>
</div>

<div id="overlay" style="width:200px;height:400px;border:1px solid #1ebfd2;float:right;margin-right:40px;">
<ul id="ol">

</ul>

</div>




 <div style="clear:both; margin-top:250px;width:80%;">
 <p class="help">Filter  By Date:</p>
 <form action="#">
		
		
		
		{{slider_ranges}}
	</form>
 
 </div>
</div>
 {% endblock %}
 